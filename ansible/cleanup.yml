---
- name: 'provision'
  hosts: all
  become: true

  tasks:

  - name: Remove old kernels
    shell: dnf remove -y $(dnf repoquery --installonly --latest-limit=-1 -q)

  - name: Delete DNF cache
    command: dnf clean all

  - name: cloud-init clean 
    shell: cloud-init clean

  - lineinfile: 
      dest: /etc/ssh/sshd_config 
      regexp: '^#?AuthenticationMethods' 
      line: 'AuthenticationMethods publickey'

  - lineinfile: 
      dest: /etc/ssh/sshd_config 
      regexp: '^#?PasswordAuthentication' 
      line: 'PasswordAuthentication no'

  - lineinfile: 
      dest: /etc/ssh/sshd_config 
      regexp: '^#?ChallengeResponseAuthentication' 
      line: 'ChallengeResponseAuthentication no'

  - lineinfile: 
      dest: /etc/ssh/sshd_config 
      regexp: '^#?PubkeyAuthentication' 
      line: 'PubkeyAuthentication yes'

  - lineinfile: 
      dest: /etc/ssh/sshd_config 
      regexp: '^#?PermitRootLogin' 
      line: 'PermitRootLogin no'
